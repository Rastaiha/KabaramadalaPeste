{% extends 'kabaramadalapeste/base.html' %}
{% load static %}
{% block styles %}
<link rel="stylesheet" href="{% static 'styles/kabaramadalapeste/game.css' %}" />
{% endblock styles %}
{% block game_base_content %}
<div id="game-container"></div>
<div class="jazire-info">
    <div class="jazire-info-header">
        <h3 class="jazire-name">جزیره <span></span></h3>
        <div class="my-row text-center" style="direction: rtl; line-height: 14px;">
            <div class="jazire_kind m-auto">
                <div class="fas fa-question-circle"></div>
                <div class="m-auto"><span></span></div>
            </div>
            <div class="jazire_persons m-auto">
                <div class="fas fa-users m-auto"></div>
                <div class="m-auto">
                    <span></span>
                    نفر
                </div>
            </div>
        </div>
    </div>
    <div class="jazire-info-body">
        <div class="my-row">
            <div class="m-auto jazire-info-question">
                <img src="{% static 'images/game/test.png' %}" style="height: 60px" />
                <div><span>حل نشده</span></div>
            </div>
            <div class="m-auto jazire-info-ganj">
                <img src="{% static 'images/game/ganj.png' %}" style="height: 60px" />
                <div><span>باز نشده</span></div>
            </div>
        </div>
        <div class="m-auto">
            <div class="m-auto jazire-info-check-time" style="font-weight: 200; font-size: 10px">
                <small>تصحیح در</small>
                <small><span></span></small>
            </div>
        </div>
        <div class="mt-1 jazire-info-action">
            <a class="my-btn" data-toggle="modal" data-target="#travel_modal"></a>
        </div>
    </div>
</div>


<div class="right-info player-info my-row">
    <div class="right-info-details">
        <div>
            <h3>خرس مهربون</h3>
            <small class="text-right">
                دارایی
            </small>
            <div>
                <div class="player-item">
                    <span>
                        <b>3 </b>×
                    </span>
                    <img src="{% static 'images/game/coins.png' %}" />
                </div>
            </div>
        </div>
    </div>
    <div class="right-info-btn">
        <img src="{% static 'images/game/bagpack.png' %}" />
    </div>
</div>


<div class="right-info exchange-info my-row">
    <div class="right-info-details">
        <div>
            <p>
                در این بخش می‌توانید دارایی خود را با سایر بازیکنان مبادله کنید.
            </p>
            <a class="my-btn w-100 mt-1" href="{% url 'kabaramadalapeste:exchange' %}">مبادله</a>
        </div>

    </div>
    <div class="right-info-btn">
        <img src="{% static 'images/game/exchange.png' %}" />
    </div>
</div>

<div class="gps">
    <img src="{% static '/images/game/gps.png' %}" />
</div>

{% include 'modal/prompt.html' with modal_id='travel_modal' %}
{% include 'modal/prompt.html' with modal_id='resize_modal' modal_title="تغییر ابعاد" modal_question="آیا مایل به بارگذاری مجدد صفحه هستید؟" %}
{% include 'modal/prompt.html' with modal_id='alert_modal' modal_title="موجودی ناکافی" modal_message="دارایی شما برای این عملیات کافی نیست." %}

{% endblock game_base_content %}
{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/konva/4.2.0/konva.min.js"></script>

<script src="{% static 'scripts/kabaramadalapeste/data.js' %}"></script>
<script src="{% static 'scripts/kabaramadalapeste/init.js' %}"></script>
<script src="{% static 'scripts/kabaramadalapeste/pure.js' %}"></script>
{% if low_q %}
<script>
    Konva.pixelRatio = 1;
</script>
{% endif %}
<script>
    $(window).on('resize', function () {
        $("#resize_modal").modal()
    });
    $('#resize_modal_btn').click(function () {
        location.reload(false);
    })

    $(".right-info-btn").click(function () {
        if ($(this).parent().hasClass("show-details")) {
            $(".right-info").removeClass("show-details");
        } else {
            $(".right-info").removeClass("show-details");
            $(this).parent().addClass("show-details");
        }
    })
    let gps_start = 0,
        gps_animation_mode, dx, dy;

    function gps_anime() {
        if (gps_start !== 0) {
            let delta = new Date() - gps_start;
            if (gps_animation_mode) {
                if (delta > 300) {
                    data.layer.x(dx);
                    data.layer2.x(dx);
                    data.layer.batchDraw();
                    data.layer2.batchDraw();
                    gps_start = 0
                } else {
                    data.layer.x(10 * Math.sin((delta * 2 * Math.PI) / 10) + dx);
                    data.layer2.x(data.layer.x());
                    data.layer.batchDraw();
                    data.layer2.batchDraw();
                }
            } else {
                if (delta > 1000) {
                    gps_start = 0;
                } else {
                    data.layer.x((data.layer.x() * (1000 - delta) / 1000 + dx * delta / 1000));
                    data.layer.y((data.layer.y() * (1000 - delta) / 1000 + dy * delta / 1000));
                    data.layer2.x(data.layer.x());
                    data.layer2.y(data.layer.y());
                    data.layer.batchDraw();
                    data.layer2.batchDraw();
                }
            }
        }
        requestAnimationFrame(gps_anime);
    }
    setTimeout(function () {
        gps_anime()
    }, 1000)
    $(".gps").click(function () {
        dx = data.stage.width() / 2 - data.ship.elem.x() - data.ship.elem.width() / 2
        dy = data.stage.height() / 2 - data.ship.elem.y() - data.ship.elem.height() / 2

        data.layer.margin.x = Math.max(
            data.layer.margin.x,
            dx,
            data.stage.width() - data.back.width - dx
        )
        data.layer.margin.y = Math.max(
            data.layer.margin.y,
            dy,
            data.stage.height() - data.back.height - dy
        )
        gps_animation_mode = 0;
        if (Math.abs(dx - data.layer.x()) < 1 && Math.abs(dy - data.layer.y()) < 1) {
            gps_animation_mode = 1;
        }
        gps_start = new Date();
    })
</script>
<script>
    (function () {
        var script = document.createElement('script');
        script.onload = function () {
            var stats = new Stats();
            document.body.appendChild(stats.dom);
            requestAnimationFrame(function loop() {
                stats.update();
                requestAnimationFrame(loop)
            });
        };
        script.src = '//mrdoob.github.io/stats.js/build/stats.min.js';
        document.head.appendChild(script);
    })()
    setTimeout(function () {
        var draw = data.layer2.draw;
        data.layer2.draw = function () {
            if (typeof stats !== "undefined") {
                stats.begin()
                draw.call(this);
                stats.end()
            } else {
                draw.call(this);
            }
        }
    }, 3000)
</script>
{% endblock scripts %}